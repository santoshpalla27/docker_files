name: Trivy Security Check

on:
  push:
    branches:
      - main
      - master
    paths:
      - '**/Dockerfile*'
      - '.github/workflows/trivy-check.yml'
  pull_request:
    paths:
      - '**/Dockerfile*'

# Required permissions for SARIF upload
permissions:
  contents: read
  security-events: write

jobs:
  # Detect which directories have changes
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_dirs: ${{ steps.changes.outputs.dirs }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed directories with Dockerfiles
        id: changes
        run: |
          # Get changed files between commits
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            # For push events, compare with parent commit
            changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$changed_files"
          
          # Find directories containing Dockerfiles that have changes
          changed_dirs=""
          
          # Get all directories with Dockerfiles
          dockerfile_dirs=$(find . -name 'Dockerfile*' -type f -not -path './.git/*' | xargs -I {} dirname {} | sort -u)
          
          for dir in $dockerfile_dirs; do
            # Remove leading ./
            clean_dir="${dir#./}"
            
            # Check if any file in this directory or its parents changed
            if echo "$changed_files" | grep -q "^$clean_dir"; then
              if [ -z "$changed_dirs" ]; then
                changed_dirs="\"$clean_dir\""
              else
                changed_dirs="$changed_dirs,\"$clean_dir\""
              fi
            fi
          done
          
          # If workflow file changed, scan all directories
          if echo "$changed_files" | grep -q "\.github/workflows/trivy-check.yml"; then
            changed_dirs=""
            for dir in $dockerfile_dirs; do
              clean_dir="${dir#./}"
              if [ -z "$changed_dirs" ]; then
                changed_dirs="\"$clean_dir\""
              else
                changed_dirs="$changed_dirs,\"$clean_dir\""
              fi
            done
          fi
          
          if [ -z "$changed_dirs" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "dirs=[]" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "dirs=[$changed_dirs]" >> $GITHUB_OUTPUT
          fi
          
          echo "Changed directories with Dockerfiles: [$changed_dirs]"

  # Scan Dockerfiles directly (no build required)
  trivy-scan:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        directory: ${{ fromJson(needs.detect-changes.outputs.changed_dirs) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image name
        id: info
        run: |
          dir="${{ matrix.directory }}"
          image_name=$(echo "$dir" | tr '/' '-')
          echo "image_name=$image_name" >> $GITHUB_OUTPUT
          echo "Scanning directory: $dir as $image_name"

      # Scan Dockerfile for misconfigurations
      - name: Trivy - Dockerfile misconfiguration scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '${{ matrix.directory }}'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH,MEDIUM'

      # Scan filesystem for vulnerabilities in dependencies
      - name: Trivy - Filesystem vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '${{ matrix.directory }}'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      # Generate JSON report for artifact
      - name: Generate JSON report
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '${{ matrix.directory }}'
          format: 'json'
          output: 'trivy-${{ steps.info.outputs.image_name }}-config.json'

      - name: Generate filesystem JSON report
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '${{ matrix.directory }}'
          format: 'json'
          output: 'trivy-${{ steps.info.outputs.image_name }}-fs.json'

      # Generate SARIF for GitHub Security tab
      - name: Generate SARIF report
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '${{ matrix.directory }}'
          format: 'sarif'
          output: 'trivy-${{ steps.info.outputs.image_name }}.sarif'

      - name: Upload to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ steps.info.outputs.image_name }}.sarif'
          category: 'trivy-${{ steps.info.outputs.image_name }}'

      - name: Upload reports as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report-${{ steps.info.outputs.image_name }}
          path: |
            trivy-${{ steps.info.outputs.image_name }}-config.json
            trivy-${{ steps.info.outputs.image_name }}-fs.json
            trivy-${{ steps.info.outputs.image_name }}.sarif
          retention-days: 30

  # Summary job
  scan-summary:
    needs: [detect-changes, trivy-scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Scan Summary
        run: |
          echo "## Trivy Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.detect-changes.outputs.has_changes }}" == "false" ]; then
            echo "âœ… No Dockerfile changes detected - scan skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“‚ Scanned directories: ${{ needs.detect-changes.outputs.changed_dirs }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.trivy-scan.result }}" == "success" ]; then
              echo "âœ… All scans completed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Some scans had issues - check results above" >> $GITHUB_STEP_SUMMARY
            fi
          fi
